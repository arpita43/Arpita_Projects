<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>A Fun Game</title>
<b>
Move the red block to save it from the falling green blocks. Use right and left keyboard arrows to move the red block.
</br>
</br>
Prize depends on how long you save yourself from enemies. Click on "Click here to play" to start the game.
</br>
</br>
</b>
<div id="target" class = "start">
  Click here to play
</div>
</br>
</br>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<div>
	<span id = "money" class = "moneybox"/>
</div>

<form id = "mturk_form" name = "mturk" action = "https://requestersandbox.mturk.com/mturk/externalSubmit" method = "POST">
	<input type='hidden' name='timePlayed' id = 'timePlayed'/>
	<input type='hidden' name='bonusAmt' id = 'bonusAmt'/>
</form>


<div id='gameboard'>
</div>

<script type = "text/javascript">

var boardSize = 500
var offset = 0
var pixSize = 50
var moneyAmt = 0
var shipLocation = [0,0,0,0,0,0,0,0,0,0] //puts the number of players on this position
var board =
			[[0,0,0,0,0,0,0,0,0,0,0],

			 [0,0,0,0,0,0,0,0,0,0,0],

			 [0,0,0,0,0,0,0,0,0,0,0],

			 [0,0,0,0,0,0,0,0,0,0,0],

			 [0,0,0,0,0,0,0,0,0,0,0],

			 [0,0,0,0,0,0,0,0,0,0,0],

			 [0,0,0,0,0,0,0,0,0,0,0],

			 [0,0,0,0,0,0,0,0,0,0,0],

			 [0,0,0,0,0,0,0,0,0,0,0],

			 [0,0,0,0,0,0,0,0,0,0,0]];

	var pieceX = 0;
	var mode = 0
	$("#target").click(function() {
		var initTime = new Date().getTime();
		var newTime = new Date().getTime();
		var $gameboard = $("#gameboard");
		var piece;
		var score = 0;
		var pieceId;
		$('body').append(gameboard);
		var ship = $("<div class='ship'></div>");
		$gameboard.append(ship);
		var $moneybox = $("#moneybox")
		generateRandomTopRow(0)
		$("#money").html(moneyAmt)
		var trackMov = 0 //to track if player is actually playing
		fillTheBoard(offset, mode)
		startFall(0,0); 

		$(document).keydown(function(e) {
				if(e.keyCode==37 && pieceX >= 50) {
					// left arrow clicked
					if(shipLocation[pieceX/50] > 0)
						shipLocation[pieceX/50] -= 1
					pieceX -= pixSize;
					//shipLocation[pieceX/50] += 1
					update(pieceX,"going")
					$(".ship").css("left", pieceX + "px");
				} else if(e.keyCode == 39 && pieceX <= 400) {
					// right arrow clicked
					if(shipLocation[pieceX/50] > 0)
						shipLocation[pieceX/50] -= 1
					pieceX += pixSize;
					//shipLocation[pieceX/50] += 1
					update(pieceX,"going")
					$(".ship").css("left", pieceX + "px");
				} else if(e.keyCode == 37 && pieceX == 0){
					// left arrow clicked
					if(shipLocation[0] > 0)
						shipLocation[0] -= 1
					pieceX = 450;
					//shipLocation[450] += 1
					update(450,"going")
					$(".ship").css("left", pieceX + "px");
				} else if(e.keyCode == 39 && pieceX == 450){
					if(shipLocation[9] > 0)
						shipLocation[9] -= 1
					pieceX = 0;
					//shipLocation[0] += 1
					update(0,"going")
					$(".ship").css("left", pieceX + "px");
				}
				trackMov = 0
				newTime = new Date().getTime();
				$gameboard.append(ship);			
		}); 

		function startFall(offset, mode) {
			var i=0
			pieceId = setInterval(function() {
				var i=0
				var j=0

				update(pieceX, "going")

				//find mode
				i = 0
				mode = pieceX/50
				//alert(shipLocation)
				for(i=1; i < 10; i++){
					if(shipLocation[i] > shipLocation[mode])
						mode = i
				}

				//for updating the rows
				for(j = 9; j >=1; j--){
					for(i=0; i <10; i++){
						board[j][i] = board[j-1][i]
						fillTheBoard((j+offset)%10,mode)
					}
				}
				

				if(checkCollision(mode) || moneyAmt > 1.0){
					
					//update(-50, "over")
					
					var timePlayed = (milliseconds - initTime)/1000;
					console.log(timePlayed)
					document.getElementById("timePlayed").value = timePlayed
					moneyAmt = ((milliseconds - initTime)/1000) * 0.002 
					console.log(moneyAmt)
					document.getElementById("bonusAmt").value = moneyAmt;
					trackMov = 0
					newTime = milliseconds;
					clearInterval(pieceId);
					alert("GAME OVER. YOU EARNED $"+moneyAmt+". Click on OK to return.")
					document.getElementById("mturk_form").submit();
					
				}
				else if(!checkCollision(mode)){
					milliseconds = new Date().getTime();
					offset = Math.floor((milliseconds / 1000.0) % 10)
					generateRandomTopRow()
					moneyAmt = ((milliseconds - initTime)/1000) * 0.002 
					$("#money").html(displayMoney(moneyAmt))
					
					//to track if player is actually playing the game.
					trackMov = (milliseconds - newTime)/1000
					if(trackMov > 20){
						alert("Please use right and left keyboard arrows to move the red block." + "\nPress OK to return. ")
						//console.log("Please use right and left keyboard arrows to move the red block." + "\nPress OK to return. "+trackMov)
						trackMov = 0
						newTime = milliseconds;
					}
					//end tracking
					clearInterval(pieceId);
					startFall(offset,mode);
				}
				else {
				}

			},1000);
	
		}

		function displayMoney(moneyAmt){
			var amt = "$" + moneyAmt.toFixed(3);
			return amt;
		}

		function fillTheBoard(index,mode){
			var j=0;
			for(j=0; j < 10; j++){
				if(board[index][j] == 1){
					//alert("displaying at::: "+i+"..."+j);
					var settledPiece = $("<div class='piece' ></div>");
					settledPiece.css('left',j*pixSize + 'px')
					settledPiece.css('top',index*pixSize + 'px')
					$gameboard.append(settledPiece);
				}
				else{
					//alert("displaying at grey::: "+i+"..."+j);	
					var settledPiece = $("<div class='destroypiece'></div>");
					//console.log("displaying at grey::: "+i+"..."+j);
					settledPiece.css('left', j*pixSize + 'px');
					settledPiece.css('top', index*pixSize + 'px');
					$gameboard.append(settledPiece);
				}
				
			}
			console.log(shipLocation)
			$(".ship").css("left", mode*50 + "px");
			$gameboard.append(ship);
		}

		function generateRandomTopRow(){
			var i=0

			var numOfCulprits = Math.floor((Math.random() * 50) + 0)%2
			if(numOfCulprits == 1){
				var col = Math.floor((Math.random() * 10) + 0);
				for(i = 0; i < 10; i++){
					if(i == col)
						board[0][i] = 1
					else
						board[0][i] = 0
				}
			}
			else{
				var col1 = Math.floor((Math.random() * 10) + 0);
				var col2 = Math.floor((Math.random() * 10) + 0);
				for(i = 0; i < 10; i++){
					if(i == col1 || i == col2)
						board[0][i] = 1
					else
						board[0][i] = 0
				}
			}
		}

		function checkCollision(mode){
			var result = false
			if(board[9][mode] == 1){
				result = true;
				console.log("collision")
				for(var k=0; k<10; k++){
					update(k*50,"over")
				}
			}	
			return result;
		}

		function update(shipLoc,stat) {

		    var dataParam = (shipLoc/50).toString()
		    
		    $.ajax({
			    url: "http://codingthecrowd.com/counter.php?key=arpita&data=dataParam&status=stat",
			 
			    // Tell jQuery we're expecting JSONP
			    dataType: "jsonp",
			 
			    // Tell YQL what we want and that we want JSON
			    data: {
				data: dataParam,
				status: stat
			    
		    },
		 
		    // Work with the response
		    success: function( response ) {

			for(var k=0; k < response["results"].length; k++){
				if(response["results"][k]["status"] == "over"){
					milliseconds = new Date().getTime();
					var timePlayed = (milliseconds - initTime)/1000;
					console.log(timePlayed)
					document.getElementById("timePlayed").value = timePlayed
					moneyAmt = ((milliseconds - initTime)/1000) * 0.002 
					console.log(moneyAmt)
					document.getElementById("bonusAmt").value = moneyAmt;
					trackMov = 0
					newTime = milliseconds;
					clearInterval(pieceId);
					alert("GAME OVER. YOU EARNED $"+moneyAmt+". Click on OK to return.")
					document.getElementById("mturk_form").submit();
				}
			}


			//$("#value").html( response["results"].length); // server response
			
			shipLocation[dataParam] = response["results"].length
			//alert(shipLocation)
			//$("#value").html( response["results"][0]["sid"]); // server response
		    }
		});
	}
		
	});
</script>
</div>
<style>
#gameboard {
	background-color: gray;
	width: 500px;
	height: 500px;
	left : 200 px;
	position: absolute;
}
.piece {
	background-color: green;
	width: 50px;
	height: 50px;
	position: absolute;
	left: 0px;
	top: 0px;
}
.ship {
	background-color: #F00;
	width: 50px;
	height: 50px;
	position: absolute;
	left: 0px;
	top: 450px;
}
.destroypiece {
	background-color: gray;
	width: 50px;
	height: 50px;
	position: absolute;
	left: 0px;
	top: 0px;
}
.moneybox {
	width: 50px;
	height: 20px;
	position: absolute;
	left: 700px;
	top: 200px;
	border-style: solid;
	padding: 10px 10px 10px 10px;
}
.start {
	position: absolute;
	left: 200px;
	color: blue;
}
	
</style>

<script type = "text/javascript">
// selector used by jquery to identify your form
var form_selector = "#mturk_form";

// function for getting URL parameters
function gup(name) {
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
  var regexS = "[\\?&]"+name+"=([^&#]*)";
  var regex = new RegExp(regexS);
  var results = regex.exec(window.location.href);
  if(results == null)
    return "";
  else return unescape(results[1]);
}

//  Turkify the captioning page.
$(document).ready(function () {
  // is assigntmentId is a URL parameter
  console.log("function started")
  if((aid = gup("assignmentId"))!="" && $(form_selector).length>0) {
     console.log(aid);
    // If the HIT hasn't been accepted yet, disabled the form fields.
    if(aid == "ASSIGNMENT_ID_NOT_AVAILABLE") {
	    $('input,textarea,select').attr("DISABLED", "disabled");
    }

    // Add a new hidden input element with name="assignmentId" that
    // with assignmentId as its value.
    var aid_input = $("<input type='hidden' name='assignmentId' value='" + aid + "'>").appendTo($(form_selector));
    console.log(aid_input);

    // Make sure the submit form's method is POST
    $(form_selector).attr('method', 'POST');

    // Set the Action of the form to the provided "turkSubmitTo" field
    if((submit_url=gup("turkSubmitTo"))!="") {
      $(form_selector).attr('action', submit_url + '/mturk/externalSubmit');
    }
  }
});
</script>
</head>
<body>
